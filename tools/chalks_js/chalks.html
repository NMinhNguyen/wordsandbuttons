<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Chalks highlighting</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <style>
body{
    margin: 0 0 0 0;
}
    </style>
    <script language="JavaScript">
function colorized_with_chalks(text) {
    const possible_separators = ['&lt;', '&gt;', ' ', '\t', '.', ',', ':', ';', '+', '-', '/', '*', '(', ')', '<', '>', '[', ']', '{', '}'];
    const possible_brackets = [['/*', '*/'], ['(*', '*)']];
    const possible_comments = ['//', '--', '#'];
    const possible_quotes = ['\'', '"']; 

    function painted_in(line, color) {
        return line.length == 0 ? line : "<span style=\"color:#" + color + "\">" + line + "</span>";
    }

    function colorized_token(token) {
        function in_hex(x) {
            return Math.floor(x / 16).toString(16) + (x % 16).toString(16);
        }
        var code_sum = 0;
        for(var i = 0; i < token.length; ++i)
            code_sum += ((i+1) * token.charCodeAt(i));
        var color = in_hex((1 + code_sum % 3) * 40) + in_hex((1 + code_sum % 4) * 30) + in_hex((1 + code_sum % 5) * 24);
        return painted_in(token, color);
    }
        
    function tokenized_and_transformed(transformed, line, separators, separator_i) {
        if(separator_i == separators.length)
            return transformed(line);
        return line.split(separators[separator_i]).map(function(piece_of_line) {
            return tokenized_and_transformed(transformed, piece_of_line, separators, separator_i + 1);
        }).join(separators[separator_i]);
    }

    function unbracketed(line, brackets_i) {
        if(line.split('&laquo;').length != 1)
            alert(line);
        if(brackets_i == possible_brackets.length)
            return tokenized_and_transformed(colorized_token, line, possible_separators, 0);
        var chunks = line.split(possible_brackets[brackets_i][0]);
        return unbracketed(chunks[0], brackets_i + 1) + chunks.slice(1).map( function(chunk) {
            var in_out_bracket = chunk.split(possible_brackets[brackets_i][1]);
            return painted_in(possible_brackets[brackets_i][0] + in_out_bracket[0] + possible_brackets[brackets_i][1], "888") 
                 + unbracketed(in_out_bracket[1], brackets_i + 1);
        }).join('');
    }

    function colorized_line(line) {
        return unbracketed(line, 0);
        /*var result = "";
        var cur_chunk = "";
        for(var i = 0; i < line.length; ++i) {
            var quote_found = false;
            for(var j = 0; j < possible_quotes.length; ++j) {
                var possible_quote = line.substr(i, possible_quotes[j][0].length);
                var possible_escape = i == 0 ? '' : line.substr(i-1, 1);
                if(possible_quote == possible_quotes[j][0] && possible_escape != '\\') {
                    quote_found = true;
                    result += tokenized_and_transformed(colorized_token, cur_chunk, possible_separators, 0);
                    cur_chunk = "" + line[i];
                    for(++i; i < line.length; ++i) {
                        cur_chunk += line[i];
                        var possible_quote_end = line.substr(i, possible_quotes[j][1].length);
                        var possible_escape = line.substr(i-1, 1);
                        if(possible_quote_end == possible_quotes[j][1] && possible_escape != '\\') {
                            i += possible_quotes[j][1].length - 1;
                            break
                        }
                    }
                    result += painted_in(cur_chunk, "888");
                    cur_chunk = "";
                    break;
                }
            }
            if(!quote_found)
                cur_chunk += line[i];
	    }
        result += tokenized_and_transformed(colorized_token, cur_chunk, possible_separators, 0);
        return result;*/
	}
    return (text.split('\n')).map(colorized_line).join('\n');
}
    </script>
    <body>
    <pre>
    <div id="code">
// solver specific to [0..1] parametrized splines
function spline_for(p1, p1d, p2, p2d) {
//     A = [
//         [1, 0, 0, 0],
//         [0, 1, 0, 0],
//         [1, 1, 1, 1],
//         [0, 1, 2, 3]];
//     B = [p1, p1d, p2, p2d]
    return [ 
        p1,     // first point
        p1d,    // first point derivative
        3 * p2 - p2d - 3*p1 - 2*p1d,
        p2d + p1d - 2*p2 + 2*p1
    ];
}

// comment -- comment # comment-comment
not comment /* comment */ not comment
a &lt; b;
a &gt; b;
word + wrod;
param_i - param_j;
a = "string";
b = 'char';
c = '\"';
d = "\'" + '\'';
e = '\"' + "\"";
left (*center*) right
    </div>   
    </pre>
    <script language="JavaScript">
document.getElementById("code").innerHTML = colorized_with_chalks(document.getElementById("code").innerHTML);
    </script>
    </body>
</html>    
