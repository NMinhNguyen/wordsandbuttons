<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Chalks highlighting</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <style>
body{
    margin: 0 0 0 0;
}
    </style>
    <script language="JavaScript">
function colorized_with_chalks(text) {
    const possible_separators = [' ', '\t', '.', ',', '+', '-', '/', '*', '(', ')', '<', '>', '[', ']', '{', '}', '&lt;', '&gt;'];
    const possible_quotes = [['//', '\n'], ['--', '\n'], ['#', '\n'], ['\'', '\''], ['"', '"'], ['/*', '*/']];

    function painted_in(line, color) {
        if(line.length == 0)
            return line;
        return "<span style=\"color:#" + color + "\">" + line + "</span>";
    }

    function colorized_token(token) {
        function in_hex(x) {
            return Math.floor(x / 16).toString(16) + (x % 16).toString(16);
        }
        var code_sum = 0;
        for(var i = 0; i < token.length; ++i)
            code_sum += (i + token.charCodeAt(i));
        var color = in_hex((1 + code_sum % 3) * 40) + in_hex((1 + code_sum % 4) * 30) + in_hex((1 + code_sum % 5) * 24);
        return painted_in(token, color);
    }
        
    function tokenized_and_transformed(transformed, line, separators, separator_i) {
        if(separator_i == separators.length)
            return transformed(line);
        var result = line.split(separators[separator_i]).map(function(piece_of_line) {
            return tokenized_and_transformed(transformed, piece_of_line, separators, separator_i + 1);
        }).join(separators[separator_i]);
        return result;
    }

/*    function code_and_comment_in(line, separators, separator_i) {
        if (separator_i == separators.length)
            return [line, ""];
        var separated = line.split(separators[separator_i]);
        var code_or_not_and_comments = code_and_comment_in(separated[0], separators, separator_i + 1);
        separated[0] = '';
        code_or_not_and_comments[1] += separated.join(separators[separator_i]);
        return code_or_not_and_comments;
    }

    function colorized_line(line) {
        var code_and_comment = code_and_comment_in(line, possible_comments, 0);
        return tokenized_and_transformed(colorized_token, code_and_comment[0], possible_separators, 0) + painted_in(code_and_comment[1], "999");
    }*/

    function colorized_line(line) {
        var result = "";
        var cur_chunk = "";
        for(var i = 0; i < line.length; ++i) {
            var quote_found = false;
            for(var j = 0; j < possible_quotes.length; ++j) {
                var possible_quote = line.substr(i, possible_quotes[j][0].length);
                var possible_escape = i == 0 ? '' : line.substr(i-1, 1);
                if(possible_quote == possible_quotes[j][0] && possible_escape != '\\') {
                    quote_found = true;
                    result += tokenized_and_transformed(colorized_token, cur_chunk, possible_separators, 0);
                    cur_chunk = "";
                    for(; i < line.length; ++i) {
                        cur_chunk += line[i];
                        possible_quote_end = line.substr(i, possible_quotes[j][1].length);
                        if(possible_quote_end == possible_quotes[j][1]) {
                            i += possible_quotes[j][1].length;
                            break
                        }
                    }
                    result += painted_in(cur_chunk, "888");
                    cur_chunk = "";
                    break;
                }
            }
            if(!quote_found)
                cur_chunk += line[i];
	    }
        result += tokenized_and_transformed(colorized_token, cur_chunk, possible_separators, 0);
        return result;
	}
        
    function colorized_lines(lines) {
        return lines.map(colorized_line);
    }
    return colorized_lines(text.split('\n')).join('\n');
}
    </script>
    <body>
    <pre>
    <div id="code">
// solver specific to [0..1] parametrized splines
function spline_for(p1, p1d, p2, p2d) {
//     A = [
//         [1, 0, 0, 0],
//         [0, 1, 0, 0],
//         [1, 1, 1, 1],
//         [0, 1, 2, 3]];
//     B = [p1, p1d, p2, p2d]
    return [ 
        p1,     // first point
        p1d,    // first point derivative
        3 * p2 - p2d - 3*p1 - 2*p1d,
        p2d + p1d - 2*p2 + 2*p1
    ];
}

// comment -- comment # comment-comment
a &lt; b;
a &gt; b;
word + wrod;
param_i - param_j;
a = "string";
b = 'char';
c = '\"';
d = "\'";
    </div>   
    </pre>
    <script language="JavaScript">
document.getElementById("code").innerHTML = colorized_with_chalks(document.getElementById("code").innerHTML);
    </script>
    </body>
</html>    
