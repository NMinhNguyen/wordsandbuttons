<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Inverse-weight interpolation</title>
    <meta name="keywords" content="iterative,algorithms,guide,tutorial,learning">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <style>
body{
    margin: 0 0 0 0;
}

a{
    text-decoration: none;
}

h1 {
    padding-top: 32pt;
    font-size: 24pt;
    width: 600pt;
    text-align: left;
}

h2 {
    padding-top: 16pt;
    font-size: 20pt;
    width: 555pt;
    text-align: left;
}

p {
    font-size: 16pt;
    width: 505pt;
    text-align: left;
}

.results {
    font-family: sans-serif;
    font-size: 14pt;
    width: 505pt;
    text-align: left;
}

.formula {
    font-family: sans-serif;
    font-size: 16pt;
    font-style: italic;
    width: 505pt;
    text-align: center;
    padding-top: 6pt;
    padding-bottom: 6pt;
}

table.footer {
    padding: 64pt 0pt 32pt 0pt;
    background-color: transparent;
    width: 505pt;
}

td.footer {
    font-family: sans-serif;
    font-size: 16pt;
    font-style: normal;
    padding: 0;
    margin: 0;
    border: 0;
}

li {
    font-size: 16pt;
    width: 505pt;
    text-align: left;
    padding-bottom: 6pt;
}

form {
    margin: 0 0 0 0;
    padding-top: 12pt;
    padding-left: 12pt;
    padding-right: 12pt;
    padding-bottom: 12pt;
    font-size: 16pt;
    text-align: left;
    width: 505pt;
    background-color: #eeee99;
}

input[type="text"] {
    width: 48pt;
    height: 22pt;
    font-size: 16pt;
    text-align: center;
}

input[type="radio"] {
    height: 16pt;
    width: 16pt;
    font-size: 16pt;
}

input[type="checkbox"] {
    height: 16pt;
    width: 16pt;
    font-size: 16pt;
    margin-bottom: 16pt;
}

button {
    width: 128pt;
    height: 26pt;
    font-size: 16pt;
    text-align: center;
}

textarea {
    width: 600pt;
    font-size: 12pt;
    font-family: monospace;
}

.comment {
    font-size: 12pt;
    text-align:center;
    font-family: sans-serif;
    padding-bottom: 24pt;
}
    </style>
    <script language="JavaScript">
// pixels
var pixels = [];

// frame points
var points = [[100, 100], [200, 100], [200, 200], [100, 200]];
function nearest_point(xy) {
    function d(xy1, xy2) {
        return (xy1[0] - xy2[0])*(xy1[0] - xy2[0]) + (xy1[1] - xy2[1])*(xy1[1] - xy2[1]);
    }
    var nearest_i = 0;
    var nearest_d = d(xy, points[0]);
    for(var i = 1; i < 4; ++i) {
        const di = d(xy, points[i]);
        if(di < nearest_d) {
            nearest_d = di;
            nearest_i = i;
        }
    }
    return nearest_i;
}
function set_points(xy) {
    const i = nearest_point(xy);
    points[i][0] = xy[0]
    points[i][1] = xy[1]
    if(i == 0) {
        points[1][1] = xy[1];
        points[3][0] = xy[0];
    } else if(i == 1) {
        points[0][1] = xy[1];
        points[2][0] = xy[0];
    } else if(i == 2) {
        points[3][1] = xy[1];
        points[1][0] = xy[0];
    } else if(i == 3) {
        points[2][1] = xy[1];
        points[0][0] = xy[0];
    }
}


function load_pixels_from(url) {
    var img = new Image();
    img.addEventListener('load', function() {
        const w = img.width;
        const h = img.height;
        var canvas = document.getElementById("canvas");
        var context = canvas.getContext('2d');
        canvas.width = w;
        canvas.height = h;
        context.drawImage(img, 0, 0 );
        var image_data = context.getImageData(0, 0, w, h);
        pixels = [];
        for (var i = 0; i < h; ++i) {
            pixelsi = []
            for (var j = 0; j < w; ++j) {
                pixel = [
                    image_data.data[(i*w + j)*4 + 0],
                    image_data.data[(i*w + j)*4 + 1],
                    image_data.data[(i*w + j)*4 + 2]];
                pixelsi.push(pixel);
            }
            pixels.push(pixelsi);
        }
        draw_canvas()
    }, false);
    img.src = url;
}

function darn(pixels, i0, j0, i1, j1) {
    const w = pixels[0].length;
    const h = pixels.length;
    for(var i = i0; i <= i1; ++i) {
        // weight coefficients for column
        const ki0 = (i0 == 0) ? 0 : 1. / (i - (i0 - 1));
        const ki1 = (i1 == h) ? 0 : 1. / (i1 + 1 - i);
        for(var j = j0; j <= j1; ++j) {
            // weight coefficients for row
            const kj0 = (j0 == 0) ? 0 : 1. / (j - (j0 - 1));
            const kj1 = (j1 == w) ? 0 : 1. / (j1 + 1 - j);
            // donor pixel values
            const pi0 = (i0 == 0) ? 0x000000 : pixels[i0 - 1][j];
            const pi1 = (i1 == h) ? 0x000000 : pixels[i1 + 1][j];
            const pj0 = (j0 == 0) ? 0x000000 : pixels[i][j0 - 1];
            const pj1 = (j1 == w) ? 0x000000 : pixels[i][j1 + 1];
            // blending
            const d = ki0 + ki1 + kj0 + kj1;
            const r = (pi0[0] * ki0 + pi1[0] * ki1 + pj0[0] * kj0 + pj1[0] * kj1) / d;
            const g = (pi0[1] * ki0 + pi1[1] * ki1 + pj0[1] * kj0 + pj1[1] * kj1) / d;
            const b = (pi0[2] * ki0 + pi1[2] * ki1 + pj0[2] * kj0 + pj1[2] * kj1) / d;
            pixels[i][j] = [r, g, b];
        }
    }
}



function init_canvas(){
    const canvas = document.getElementById("canvas");
    const canvas_rect = canvas.getBoundingClientRect();

    canvas.addEventListener('mousemove', function(e){
        var canvas_rect = canvas.getBoundingClientRect();
        if(e.buttons == 1){
            const x = e.clientX - canvas_rect.left;
            const y = e.clientY - canvas_rect.top;
            set_points([x, y]);
            draw_canvas();
        }
    }, false);

    canvas.addEventListener('mousedown', function(e){
        var canvas_rect = canvas.getBoundingClientRect();
        const x = e.clientX - canvas_rect.left;
        const y = e.clientY - canvas_rect.top;
        set_points([x, y]);
        draw_canvas();
    }, false);

    canvas.addEventListener('mouseleave', function(e){
        draw_canvas();
    }, false);

    draw_canvas();
}

function draw_canvas(){
    var canvas = document.getElementById("canvas");
    var context = canvas.getContext("2d");
    if(pixels.length == 0)
        return
    const w = pixels[0].length;
    const h = pixels.length;

    // background
    context.fillStyle="#eeeeee";
    context.fillRect(0, 0, w, h);
    
    // pixels
    var pixel_field = context.createImageData(w, h);
    for (var i = 0; i < h; ++i) {
        for (var j = 0; j < w; ++j) {
            pixel_field.data[(i*w + j)*4 + 0] = pixels[i][j][0];
            pixel_field.data[(i*w + j)*4 + 1] = pixels[i][j][1];
            pixel_field.data[(i*w + j)*4 + 2] = pixels[i][j][2];
            pixel_field.data[(i*w + j)*4 + 3] = 0xFF;
        }
    }
    context.putImageData(pixel_field, -0.5, -0.5);
    
    // frame
    context.beginPath();
    context.moveTo(points[0][0] + 0.5, points[0][1] + 0.5);
    context.lineTo(points[1][0] + 0.5, points[1][1] + 0.5);
    context.lineTo(points[2][0] + 0.5, points[2][1] + 0.5);
    context.lineTo(points[3][0] + 0.5, points[3][1] + 0.5);
    context.lineTo(points[0][0] + 0.5, points[0][1] + 0.5);
    context.strokeStyle = "#d64562";
    context.setLineDash([4, 4]);
    context.lineWidth = 3;
    context.stroke();
    context.closePath();
    context.setLineDash([]);
}


  </script>
  </head>
  <body>
    <center>
    <h1>
Inverse weight inerpolation
    </h1>
    <canvas id="canvas" width=1024 height=1024></canvas>
    <script language="JavaScript">
//    load_pixels_from('https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Ancient_Greece_Northern_Part_Map.jpg/800px-Ancient_Greece_Northern_Part_Map.jpg');
    load_pixels_from('helix.jpg');
    init_canvas();
    </script>


    </center>
  </body>
</html>
