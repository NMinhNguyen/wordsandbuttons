<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Polynomial approximation and interpolation</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <style>
body{
    margin: 0 0 0 0;
}

a{
    text-decoration: none;
}

h1 {
    padding-top: 32pt;
    font-size: 24pt;
    width: 600pt;
    text-align: left;
}

h2 {
    padding-top: 16pt;
    font-size: 20pt;
    width: 555pt;
    text-align: left;
}

p {
    font-size: 16pt;
    width: 505pt;
    text-align: left;
}

.results {
    font-family: sans-serif;
    font-size: 14pt;
    width: 505pt;
    text-align: left;
}

.formula {
    font-family: sans-serif;
    font-size: 16pt;
    font-style: italic;
    width: 505pt;
    text-align: center;
    padding-top: 6pt;
    padding-bottom: 6pt;
}

.brackets {
    font-size:48pt;
    padding-bottom:8pt;
    font-family: sans-serif;
    font-weight: 100;
    font-style: normal;
}

table.footer {
    padding: 64pt 0pt 32pt 0pt;
    background-color: transparent;
    width: 505pt;
}

td.footer {
    font-family: sans-serif;
    font-size: 16pt;
    font-style: normal;
    padding: 0;
    margin: 0;
    border: 0;
}

li {
    font-size: 16pt;
    width: 505pt;
    text-align: left;
    padding-bottom: 6pt;
}

form {
    margin: 0 0 0 0;
    padding-top: 12pt;
    padding-left: 12pt;
    padding-right: 12pt;
    padding-bottom: 12pt;
    font-size: 16pt;
    text-align: left;
    width: 505pt;
    background-color: #eeee99;
}

input[type="text"] {
    width: 32pt;
    height: 22pt;
    font-size: 16pt;
    text-align: center;
}

button {
    width: 32pt;
    height: 26pt;
    font-size: 16pt;
    text-align: center;
}
    </style>
    <script language="JavaScript">
// client
var w = 640.0;
var h = 640.0;

var points = [];

// above
var app_degree = 3;
function change_app_degree() {
    app_degree = Number(document.getElementById("app_degree_input").value);
    if(isNaN(app_degree)) {
        app_degree = 1;
    }
    document.getElementById("app_degree_input").value = app_degree;
    draw_all_canvases();
}

var both_degree = 3;
function change_both_degree() {
    both_degree = Number(document.getElementById("both_degree_input").value);
    if(isNaN(both_degree)) {
        both_degree = 1;
    }
    document.getElementById("both_degree_input").value = both_degree;
    draw_all_canvases();
}

var ips = 1;
function change_ips() {
    ips = Number(document.getElementById("ips_input").value);
    if(isNaN(ips)) {
        ips = 1;
    }
    document.getElementById("ips_input").value = ips;
    draw_all_canvases();
}


function inc(counter_name) {
    var counter = document.getElementById(counter_name+"_input");
    counter.value = Number(counter.value) + 1;
    eval('change_' + counter_name + '()');
}

function dec(counter_name) {
    var counter = document.getElementById(counter_name+"_input");
    counter.value = Number(counter.value) - 1;
    eval('change_' + counter_name + '()');
}

// alrorithms
function sign_0_positive(x){ // Math.sign like with no 0 option
    if(x >= 0)
        return 1.0;
    return -1.0;
}

function underflow_padded(x){
    if(Math.abs(x) < 1.e-5) // pixel-size input error is ok, so we don't want much precision anyway
        return 1.e-5 * sign_0_positive(x);
    return x;
}

function solved_linear(A, B, n){
    var X = [];
    for (var i = 0; i < n; ++i)
        X.push(0.0);

    // triangulize
    for (var i = 0; i < n-1; ++i)
        for (var j = 0; j < i+1; ++j) {
            r = A[i+1][j] / underflow_padded(A[j][j]);
            A[i+1][j] = 0.;
            for (var b_j = j+1; b_j < n; ++b_j){
                A[i+1][b_j] -= A[j][b_j]*r;
            }
            B[i+1] -= B[j]*r;
        }

    // calculate xs
    X[n-1] = B[n-1] / underflow_padded(A[n-1][n-1]);
    for (var i = n-2; i >= 0; --i){
        var s = 0.0;
        for (var j = i; j < n; ++j){
            s = s + A[i][j]*X[j];
        }
        X[i] = (B[i] - s) / underflow_padded(A[i][i]);
    }
    return X;
}

function approximation_of(points, n) {
    const N = points.length;
    var A = [];
    var B = [];

    for (var i = 0; i < n; ++i){
        var Ai = []
        for (var j = 0; j < n; ++j){
            Ai.push(0);
            for(var k = 0; k < N; ++k){
                Ai[j] += Math.pow(points[k][0], i + j);
            }
        }
        A.push(Ai);
        B.push(0);
        for(var k = 0; k < N; ++k){
            B[i] += points[k][1] * Math.pow(points[k][0], i);
        }
    }
    P = solved_linear(A, B,n);
    return function(x) {
        Px = 0;
        for(var i = 0; i < n; ++i) {
            Px += P[i] * Math.pow(x, i);
        }
        return Px;
    };
}

function interpolation_of(points) {
    const N = points.length;
    var A = [];
    var B = [];

    for (var i = 0; i < N; ++i){
        var Ai = []
        for (var j = 0; j < N; ++j){
            Ai.push(Math.pow(points[i][0], j));
        }
        A.push(Ai);
        B.push(points[i][1]);
    }
    P = solved_linear(A, B, N);
    return function(x) {
        Px = 0;
        for(var i = 0; i < N; ++i) {
            Px += P[i] * Math.pow(x, i);
        }
        return Px;
    };
}

function approximation_with_weighted_ips(points, n, weight) {
    const N = points.length;
    var A = [];
    var B = [];

    for (var i = 0; i < n; ++i){
        var Ai = []
        for (var j = 0; j < n; ++j){
            Ai.push(0);
            for(var k = 0; k < N; ++k){
                Ai[j] += Math.pow(points[k][0], i + j) * ((k < ips) ? weight : 1.0);
            }
        }
        A.push(Ai);
        B.push(0);
        for(var k = 0; k < N; ++k){
            B[i] += points[k][1] * Math.pow(points[k][0], i) * ((k < ips) ? weight : 1.0);
        }
    }
    P = solved_linear(A, B,n);
    return function(x) {
        Px = 0;
        for(var i = 0; i < n; ++i) {
            Px += P[i] * Math.pow(x, i);
        }
        return Px;
    };
}

function evaluate_by_ips_squared_error(f) {
    var error2 = 0.0;
    for(var i = 0; i < ips; ++i) {
        error2 += Math.pow(points[i][1] - f(points[i][0]), 2);
    }
    return error2;
}

function approximation_with_autoweighted_ips(points, n) {
    var weight = 1.0;
    var error2 = 1.0;
    while (error2 >= 1.0) {
        f = approximation_with_weighted_ips(points, n, weight);
        error2 = evaluate_by_ips_squared_error(f);
        weight *= 2;
    }
    return f;
}

// the canvases
function init_canvas(canvas_name){
    var canvas = document.getElementById(canvas_name);
    canvas.addEventListener('mousedown', function(e){
        canvas_rect = canvas.getBoundingClientRect();
        points.push([e.clientX - canvas_rect.left, e.clientY - canvas_rect.top]);
    }, false);
     
    canvas.addEventListener('mousemove', function(e){
        if(e.buttons == 1){
            canvas_rect = canvas.getBoundingClientRect();
            points[points.length-1] = [e.clientX - canvas_rect.left, e.clientY - canvas_rect.top];
            draw_all_canvases();
        }
    }, false);
    
    canvas.addEventListener('mouseup', function(e){
        canvas_rect = canvas.getBoundingClientRect();
        points[points.length-1] = [e.clientX - canvas_rect.left, e.clientY - canvas_rect.top];
        draw_all_canvases();
    }, false);
    
    draw_all_canvases();
}

function draw_all_canvases() {
    draw_canvas("approximation_canvas");
    draw_canvas("interpolation_canvas");
    draw_canvas("both_canvas");
}

function write_approximation_formula() {
    var approximation_formula = document.getElementById("approximation_formula");
    formula_html = "<table><tr>";   // A x = B
    formula_html += "<td class=\"brackets\">[</td>";
    formula_html += "<td>"; 
    formula_html += "<table>"; // A
    for(var i = 0; i < app_degree + 1; ++i) {
        formula_html += "<tr>";
        for(var j = 0; j < app_degree + 1; ++j) {
            formula_html += "<td style=\"padding:4pt 4pt 4pt 4pt;\">";
            if(i + j == 0) {
                formula_html += "n";
            } else {
                formula_html += "<table style=\"font-family: sans-serif; font-size: 16pt;\">";
                formula_html += "<tr><td align=\"center\" style=\"font-size: 10pt;\">";
                formula_html += "n";
                formula_html += "</td><td rowspan=3>";
                if(i + j == 1)
                    formula_html += "<table><tr><td rowspan=2>x</td><td style=\"font-size: 10pt;\">&nbsp;</td></tr><tr><td style=\"font-size: 10pt;\">k</td></tr></table>"
                else
                    formula_html += "<table><tr><td rowspan=2>x</td><td style=\"font-size: 10pt;\">" + String(i + j) + "</td></tr><tr><td style=\"font-size: 10pt;\">k</td></tr></table>"
                formula_html += "</td>";
                formula_html += "</tr><tr><td style=\"font-size:20pt;\">";
                formula_html += "&Sigma;";
                formula_html += "</td></tr><tr><td align=\"center\" style=\"font-size: 10pt;\">";
                formula_html += "k=1";
                formula_html += "</td></tr>";
                formula_html += "</table>";
            }
            formula_html += "</td>";            
        }
        formula_html += "</tr>";
    }
    formula_html += "</table>"; // A    
    formula_html += "</td>";
    formula_html += "<td class=\"brackets\">]</td>";
    
    formula_html += "<td class=\"brackets\">[</td>";
    formula_html += "<td>"; 
    formula_html += "<table>"; // x
    for(var i = 0; i < app_degree + 1; ++i) {
        formula_html += "<tr>";
        formula_html += "<td style=\"padding:4pt 4pt 4pt 4pt;\">";
        formula_html += "<table><tr><td rowspan=2>a</td><td style=\"font-size: 10pt;\">&nbsp;</td></tr><tr><td style=\"font-size: 10pt;\">" + String(i) + "</td></tr></table>"
        formula_html += "</td>";            
        formula_html += "</tr>";
    }
    formula_html += "</table>"; // x    
    formula_html += "</td>";
    formula_html += "<td class=\"brackets\">]</td>";
    
    formula_html += "<td class=\"brackets\">=</td>";
    
    formula_html += "<td class=\"brackets\">[</td>";
    formula_html += "<td>"; 
    formula_html += "<table>"; // B
    for(var i = 0; i < app_degree + 1; ++i) {
        formula_html += "<tr>";
        formula_html += "<td style=\"padding:4pt 4pt 4pt 4pt;\">";
        formula_html += "<table style=\"font-family: sans-serif; font-size: 16pt;\">";
        formula_html += "<tr><td align=\"center\" style=\"font-size: 10pt;\">";
        formula_html += "n";
        formula_html += "</td><td rowspan=3>";
        if(i == 0)
            formula_html += "<table><tr><td rowspan=2>y</td><td style=\"font-size: 10pt;\">&nbsp;</td></tr><tr><td style=\"font-size: 10pt;\">k</td></tr></table>"
        else if(i == 1) {
            formula_html += "<table><tr><td rowspan=2>y</td><td style=\"font-size: 10pt;\">&nbsp;</td><td rowspan=2>x</td><td style=\"font-size: 10pt;\">&nbsp;</td></tr>"
            formula_html += "<tr><td style=\"font-size: 10pt;\">k</td><td style=\"font-size: 10pt;\">k</td></tr></table>"
        } else {
            formula_html += "<table><tr><td rowspan=2>y</td><td style=\"font-size: 10pt;\">&nbsp;</td><td rowspan=2>x</td><td style=\"font-size: 10pt;\">" + String(i) + "</td></tr>"
            formula_html += "<tr><td style=\"font-size: 10pt;\">k</td><td style=\"font-size: 10pt;\">k</td></tr></table>"
        }
        formula_html += "</td>";
        formula_html += "</tr><tr><td style=\"font-size:20pt;\">";
        formula_html += "&Sigma;";
        formula_html += "</td></tr><tr><td align=\"center\" style=\"font-size: 10pt;\">";
        formula_html += "k=1";
        formula_html += "</td></tr>";
        formula_html += "</table>";
        formula_html += "</td>";            
        formula_html += "</tr>";
    }
    formula_html += "</table>"; // B    
    formula_html += "</td>";
    formula_html += "<td class=\"brackets\">]</td>";
    
    formula_html += "</tr></table>";  // A x = B
    approximation_formula.innerHTML = formula_html;
}

function draw_canvas(canvas_name){
    var canvas = document.getElementById(canvas_name);
    var context = canvas.getContext("2d");
    // background
    context.fillStyle="#eeeeee";
    context.fillRect(0, 0, w, h);
    
    // points
    for (var i = 0; i < points.length; ++i) {
        if(canvas_name == "both_canvas" && i < ips) 
            context.fillStyle="#880088";
        else
            context.fillStyle="#008800"; 
        context.beginPath();
        context.arc(points[i][0], points[i][1], 3, 0, 2*Math.PI);
        context.fill();
        context.closePath();
    }
    
    // draw approximation
    if(canvas_name == "approximation_canvas") {
        if(points.length > 0) {
            var polynomial = approximation_of(points, app_degree + 1);
            
            context.beginPath();
            for(var j = 1; j < w; ++j){
                x1 = j - 1;
                x2 = j;
                y1 = polynomial(x1);
                y2 = polynomial(x2);
                context.moveTo(x1, y1);
                context.lineTo(x2, y2);
            }
            context.strokeStyle="#661100";
            context.stroke();
            context.closePath();
        }
        write_approximation_formula();
    }
    
    // draw interpolation
    if(canvas_name == "interpolation_canvas") {
        if(points.length > 0) {
            var polynomial = interpolation_of(points);
            
            context.beginPath();
            for(var j = 1; j < w; ++j){
                x1 = j - 1;
                x2 = j;
                y1 = polynomial(x1);
                y2 = polynomial(x2);
                context.moveTo(x1, y1);
                context.lineTo(x2, y2);
            }
            context.strokeStyle="#006611";
            context.stroke();
            context.closePath();
        }
    }
    
    // draw approximation + interpolation
    if(canvas_name == "both_canvas") {
        if(points.length > 0) {
            var polynomial = approximation_with_autoweighted_ips(points, both_degree + 1);
            
            context.beginPath();
            for(var j = 1; j < w; ++j){
                x1 = j - 1;
                x2 = j;
                y1 = polynomial(x1);
                y2 = polynomial(x2);
                context.moveTo(x1, y1);
                context.lineTo(x2, y2);
            }
            context.strokeStyle="#001166";
            context.stroke();
            context.closePath();
        }
    }    
}

// under
function reset_all() {
    points = [];
    draw_all_canvases();
}

function undo_last() {
    points.splice(-1,1);
    draw_all_canvases();
}
    </script>
  </head>
  <body>
    <center>
    <h1>
Polynomial approximation and interpolation
    </h1>
    <p>
...
    </p>
    <h2>
Approximation
    </h2>
    <p>
...    
    </p>
    <form onsubmit="return false;">   
    Polynomial degree:
    <button type="button" onclick="dec('app_degree')">-</button>
    <input type="text" id="app_degree_input" value="3" onchange="change_app_degree();">
    <button type="button" onclick="inc('app_degree')">+</button>
    <br>    
    </form>
    <canvas id="approximation_canvas" width=640 height=640></canvas>
    <div style="text-align:right; width:640px; padding-bottom:12pt;">
        <button type="button" style="width: 108pt;" onclick="undo_last()">Undo last</button>
        <button type="button" style="width: 108pt;" onclick="reset_all()">Reset all</button>
    </div>
    <p id="approximation_formula" class="formula">
    
    </p>
    
    
    <h2>
Interpolation
    </h2>
    <p>
...    
    </p>
    <canvas id="interpolation_canvas" width=640 height=640></canvas>
    <div style="text-align:right; width:640px; padding-bottom:12pt;">
        <button type="button" style="width: 108pt;" onclick="undo_last()">Undo last</button>
        <button type="button" style="width: 108pt;" onclick="reset_all()">Reset all</button>
    </div>    
    <p id="interpolation_formula" class="formula">
    <table>
    <tr>
    <td>
        <table style="font-family: sans-serif; font-size: 16pt;">
        <tr><td>
            x<sup>i</sup>
        </td></tr>
        </table>
    </td>
    </tr>
    </table>
    </p>
    
    <h2>
Why not have both?
    </h2>
    <p>
...    
    </p>
    <form onsubmit="return false;">
    Polynomial degree:
    <button type="button" onclick="dec('both_degree')">-</button>
    <input type="text" id="both_degree_input" value="3" onchange="change_both_degree();">
    <button type="button" onclick="inc('both_degree')">+</button>
    <br>
    Interpolation points for the combined method:
    <button type="button" onclick="dec('ips')">-</button>
    <input type="text" id="ips_input" value="1" onchange="change_ips();">
    <button type="button" onclick="inc('ips')">+</button>      
    </form>
    <canvas id="both_canvas" width=640 height=640></canvas>
    <div style="text-align:right; width:640px; padding-bottom:12pt;">
        <button type="button" style="width: 108pt;" onclick="undo_last()">Undo last</button>
        <button type="button" style="width: 108pt;" onclick="reset_all()">Reset all</button>
    </div>  
    
    <script language="JavaScript">
    init_canvas("approximation_canvas");
    init_canvas("interpolation_canvas");
    init_canvas("both_canvas");
    </script>

    <table class="footer" style="width: 555pt; padding: 64pt 0pt 32pt 0pt; background-color: transparent; font-family: sans-serif; font-size: 16pt; font-style: normal;">
    <tr>
    <td class="footer" style="vertical-align: middle; text-align: left; width: 64px; padding: 0; margin: 0; border: 0;">
        <a href="index.html"><img src="favicon.ico"></a> 
    </td>
    <td class="footer" style="vertical-align: middle; text-align: left; width: 200pt; padding: 0; margin: 0; border: 0;">
        &nbsp;&larr; there's more.
    </td>
    <td class="footer" style="vertical-align: middle; text-align: right; width: 300pt; padding: 0; margin: 0; border: 0;">
        + 
        <a href="https://github.com/akalenuk/wordsandbuttons">Github</a> & 
        <a href="https://twitter.com/wordsandbuttons">Twitter</a> & 
        <a href="https://news.ycombinator.com/from?site=wordsandbuttons.online">Hacker News</a>
    </td>
    </tr>
    </table>
    </center>
  </body>
</html>
