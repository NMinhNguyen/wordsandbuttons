<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Lexical highlighting vs. syntax highlighting</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <style>
body{
    margin: 0 0 0 0;
}

a{
    text-decoration: none;
}

h1 {
    padding-top: 32pt;
    font-size: 24pt;
    width: 600pt;
    text-align: left;
}

h2 {
    padding-top: 16pt;
    font-size: 20pt;
    width: 555pt;
    text-align: left;
}

p {
    font-size: 16pt;
    width: 505pt;
    text-align: left;
}

pre {
    margin: 0 0 0 0;
    padding-top: 6pt;
    padding-left: 6pt;
    padding-right: 6pt;
    padding-bottom: 6pt;
    font-size: 12pt;
    text-align: left;
}

table {
    border-width: 0pt;
}

td {
    vertical-align: top;
    padding: 1pt 1pt 1pt 1pt;
    font-size: 16pt;
    width: 100%;
}

form {
    margin: 0 0 0 0;
    padding-top: 12pt;
    padding-left: 12pt;
    padding-right: 12pt;
    padding-bottom: 12pt;
    font-size: 16pt;
    text-align: left;
    width: 505pt;
    background-color: #eeee99;
}

input[type="checkbox"] {
    height: 16pt;
    width: 16pt;
    font-size: 16pt;
    margin-bottom: 16pt;
}

input[type="radio"] {
    height: 16pt;
    width: 16pt;
    font-size: 16pt;
}

label {
    font-size: 16pt;
}

input[type="text"] {
    width: 100%;
    height: 22pt;
    font-size: 16pt;
    text-align: left;
}

button {
    width: 128pt;
    height: 26pt;
    font-size: 16pt;
    text-align: center;
}

textarea {
    width: 100%;
    font-size: 12pt;
    font-family: monospace;
    padding: 0pt 0pt 0pt 0pt;
    margin: 0pt 0pt 0pt 0pt;
}

    </style>
    <script language="JavaScript">
function colorized_with_sample_highlighter(text) {
   const separators = ['\n', ' ', '\t', '.', ',', ':', '=', '[', ']', '(', ')'];
   const comments = [['/*', '*/'], ['#', '\n']];

    function painted_in(line, color) {
        return line.length == 0 ? "" : "<span style=\"color:#" + color + "\">" + line + "</span>";
    }

    function colorized(token) {
        var code_sum = 0;
        for(var i = 0; i < token.length; ++i)
            code_sum += ((i+1) * token.charCodeAt(i));
        var color = '' + ((code_sum % 4) * 2) + (2 + (code_sum % 3) * 2) + (2 + (code_sum % 2) * 4);
        return painted_in(token, color);
    }

    function separated(line, i) {
        if(i == separators.length)
            return colorized(line);
        return line.split(separators[i]).map(function(subline) {
            return separated(subline, i + 1);}).join(separators[i]);
    }

    function uncommented(line, i) {
        if(i == comments.length)
            return separated(line, 0);
        var chunks = line.split(comments[i][0]);
        return uncommented(chunks[0], i + 1) + chunks.slice(1).map( function(chunk) {
            var in_out_comment = chunk.split(comments[i][1]);
            return painted_in(comments[i][0] + in_out_comment[0] + (in_out_comment.length > 1 ? comments[i][1] : ''), "777") 
                + uncommented(in_out_comment.slice(1).join(comments[i][1]), i + 1);}).join('');
    }

    return uncommented(text, 0);
}
    
function generate_highlighter_code() {
    var function_name = document.getElementById("function_name").value;
    var do_quotes = document.getElementById("do_quotes").checked;
    var do_comments = document.getElementById("do_comments").checked;
    
    var code = "\n";
    code += "function " + function_name + "(text) {\n";
    code += "   const separators = " + document.getElementById("separators_list").value + ";\n"
    if(do_quotes)
        code += "   const quotes = " + document.getElementById("quotes_list").value + ";\n"
    if(do_comments)
        code += "   const comments = " + document.getElementById("comments_list").value + ";\n"    

    code += "\n";
    code += "    function painted_in(line, color) {\n";
    code += "        return line.length == 0 ? \"\" : \"&lt;span style=\\\"color:#\" + color + \"\\\"&gt;\" + line + \"&lt;/span&gt;\";\n";
    code += "    }\n"

    code += "\n";
    code += "    function colorized(token) {\n";
    code += "        var code_sum = 0;\n";
    code += "        for(var i = 0; i < token.length; ++i)\n";
    code += "            code_sum += ((i+1) * token.charCodeAt(i));\n";
    code += "        var color = '' + ((code_sum % 4) * 2) + (2 + (code_sum % 3) * 2) + (2 + (code_sum % 2) * 4);\n";
    code += "        return painted_in(token, color);\n";
    code += "    }\n";
        

    code += "\n";
    code += "    function separated(line, i) {\n";
    code += "        if(i == separators.length)\n";
    code += "            return colorized(line);\n";
    code += "        return line.split(separators[i]).map(function(subline) {\n";
    code += "            return separated(subline, i + 1);}).join(separators[i]);\n";
    code += "    }\n";

    if(do_quotes) {
        code += "\n";    
        code += "    function unquoted(line, i) {\n";
        code += "        if(i == quotes.length)\n"; 
        code += "            return separated(line, 0);\n";
        code += "        var chunk_no = 0;\n";
        code += "        return line.split('\\\\' + quotes[i]).join('\\0').split(quotes[i]).map(function (chunk) {\n";
        code += "            return chunk.split('\\0').join('\\\\' + quotes[i]);}).map(function (chunk) {\n";
        code += "                return ++chunk_no % 2  == 1 ? unquoted(chunk, i + 1) : painted_in(quotes[i] + chunk + quotes[i], \"888\");}).join('');\n";
        code += "    }\n";
    }
    
    if(do_comments) {
        code += "\n";
        code += "    function uncommented(line, i) {\n";
        code += "        if(i == comments.length)\n";
        if(do_quotes) 
            code += "            return unquoted(line, 0);\n";
        else
            code += "            return separated(line, 0);\n";
        code += "        var chunks = line.split(comments[i][0]);\n";
        code += "        return uncommented(chunks[0], i + 1) + chunks.slice(1).map( function(chunk) {\n";
        code += "            var in_out_comment = chunk.split(comments[i][1]);\n";
        code += "            return painted_in(comments[i][0] + in_out_comment[0] + (in_out_comment.length > 1 ? comments[i][1] : ''), \"888\") \n";
        code += "                + uncommented(in_out_comment.slice(1).join(comments[i][1]), i + 1);}).join('');\n";
        code += "    }\n";
    }
    
    code += "\n";
    if(do_comments)
        code += "    return uncommented(text, 0);\n";
    else if(do_quotes)
        code += "    return unquoted(text, 0);\n";
    else 
        code += "    return separated(text, 0);\n";        
    code += "}\n";

    document.getElementById("highlighter_code").innerHTML = code;
    highlight_test_area();
}

function highlight_test_area() {
    var code = document.getElementById("highlighter_code").innerHTML;
    code = code.split('&lt;').join('<').split('&gt;').join('>');
    var function_name_context = code.split('function ');
    if(function_name_context.length == 1) 
        return
    function_name = function_name_context[1].split('(')[0];
    eval(code);
    
    var text = document.getElementById("testing_area").value;
    chunks = text.split('<')
    plain_text = chunks[0] + chunks.slice(1).map(function(chunk) {return chunk.split('>')[1]}).join('');
    document.getElementById("testing_pre").innerHTML = eval(function_name + '(plain_text);');
}
    </script>
  </head>
  <body>
    <center>
    <h1>
Lexical highlighting vs. syntax highlighting
    </h1>
    <p>
In 2013 I was working in nuclear plants automation. I can't talk much since it was all classified. But I probably wouldn't get arrested for mentioning that the job required reading a lot of assembly code.
    </p>
    <p>
Reading assembly code is not as hards as it seems to an untrained person. In fact, <a href="https://wordsandbuttons.online/you_dont_have_to_learn_assembly_to_read_disassembly.html">everyone can read a bit of disassembly</a>. But in large quantities it gets harder and harder. The mnemonics like RCR, SHRD, WBINVD, and CMPXCHG8B are fun to write, but hell to read.
    </p>
    <p>
What's worse, the standard approach to highlighting doesn't help at all. Assembly has very simple syntax so syntax highlihgting is useless. It's fine that MOV doesn't look like EAX, but I'd rather prefer PMULHW and PMULHUW to be shown as different as possible.
    </p>
    <p>
So I came up with <a href="https://github.com/akalenuk/chalks">another kind of highlighting</a>. It's not sytnax but <i>differential lexical</i> highlighting. Lexical because it doesn't need true syntax analysis, primitive tokenization and filtering is enough. And it's differential because is aims to highlight the difference between lexems. Ideally, the smaller the difference, the greated the differentiation should be.
    </p>
    <p>
It works somewhat like this.
    </p>
    <table><tr>
    <td>
    <pre id="sample_code">
  movq  %rax, %r14
  .align  16, 0x90
.LBB0_6:
  # =>This Inner Loop Header: Depth=1
  movl  -12(%r12,%rbx,4), %eax
  addl  $-1, %eax
  imull  %eax, %eax
  movl  -8(%r12,%rbx,4), %ecx
  addl  $-1, %ecx
  imull  %ecx, %ecx
  addl  %eax, %ecx
  movl  -4(%r12,%rbx,4), %eax
  addl  $-1, %eax
  imull  %eax, %eax
  addl  %ecx, %eax
  movl  (%r12,%rbx,4), %ecx
  movl  $1, %edx
  subl  %ecx, %edx
  addl  $-1, %ecx
  imull  %edx, %ecx
  cmpl  %ecx, %eax
  jne  .LBB0_7
# BB#17:   #   in Loop: Header=BB0_6 Depth=1
  incl  4(%rsp)
.LBB0_7:   # %.backedge
           #   in Loop: Header=BB0_6 Depth=1
  addq  $1, %rbx
  cmpq  $160000000, %rbx
  jne  .LBB0_6
    </pre>
    </td>
    </tr></table>
    <form>
    Separators:
    <br>
    <textarea id="separators_list" rows=2>['\n', ' ', '\t', '.', ',', ':', '=', '[', ']']</textarea>
    <br>
    <br>
    <input type="checkbox" id="do_quotes" checked /><label for="do_quotes">Quotes</label>
    <br>
    <textarea id="quotes_list" rows=2>['\'', '"']</textarea>
    <br>
    <br>
    <input type="checkbox" id="do_comments" checked /><label for="do_comments">Comments</label>
    <br>
    <textarea id="comments_list" rows=2>[['/*', '*/'], [';', '\n']]</textarea>
    <br>
    <br>
    Function name:
    <br>
    <input type="text" id="function_name" value="colorized">
    <br>
    <br>
    <button type="button" style="width: auto;" onclick="generate_highlighter_code()">Regenerate the highlighter</button><br>
    </form>
    
    <table><tr>
    <td style="border: 1px solid black;">
    <pre id="highlighter_code">
... here will be the highlighter code...
    </pre>
    </td></tr></table>
    
    <form style="width:600pt;">
    Testing area:
    <table style="width:100%;">
    <tr>
    <td style="width:50%;">
    <textarea id="testing_area" rows=25 onInput="highlight_test_area()">
.data 
/* some sample strings */
ClassName db "SimpleWinClass", 0
AppName  db " ", 0

.code
/* some sample code */

; increment counter
.elseif wParam=='I'
    mov esi, offset counter_values
    mov ecx, i
    mov eax, [esi + ecx*4]
    inc eax
    mov [esi + ecx*4], eax
; decrement counter
.elseif wParam=='D'
    mov esi, offset counter_values
    mov ecx, i
    mov eax, [esi + ecx*4]
    dec eax
    mov [esi + ecx*4], eax
    </textarea>
    </td>
    <td style="width:50%;">
    <pre id="testing_pre"></pre>
    </td>
    </tr>
    </table>
    </form>

    <script language="JavaScript">
    generate_highlighter_code();
    document.getElementById("sample_code").innerHTML = colorized_with_sample_highlighter(document.getElementById("sample_code").innerHTML);
    </script>


    <table class="footer" style="width: 555pt; padding: 64pt 0pt 32pt 0pt; background-color: transparent; font-family: sans-serif; font-size: 16pt; font-style: normal;">
    <tr>
    <td class="footer" style="vertical-align: middle; text-align: left; width: 64px; padding: 0; margin: 0; border: 0;">
        <a href="index.html"><img src="favicon.ico"></a>
    </td>
    <td class="footer" style="vertical-align: middle; text-align: left; width: 200pt; padding: 0; margin: 0; border: 0;">
        &nbsp;&larr; there's more.
    </td>
    <td class="footer" style="vertical-align: middle; text-align: right; width: 300pt; padding: 0; margin: 0; border: 0;">
        +
        <a href="https://github.com/akalenuk/wordsandbuttons">Github</a> &
        <a href="https://twitter.com/wordsandbuttons">Twitter</a> &
        <a href="https://news.ycombinator.com/from?site=wordsandbuttons.online">Hacker News</a>
    </td>
    </tr>
    </table>
    </center>
  </body>
</html>
