<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Outperforming LAPACK with C metaprogramming</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <style>
body{
    margin: 0 0 0 0;
}

a{
    text-decoration: none;
}

h1 {
    padding-top: 32pt;
    font-size: 24pt;
    width: 600pt;
    text-align: left;
}

h2 {
    padding-top: 16pt;
    font-size: 20pt;
    width: 555pt;
    text-align: left;
}

p {
    font-size: 16pt;
    width: 505pt;
    text-align: left;
}

.footer {
    margin-top: 64pt;
    padding-bottom: 32pt;
    font-family: sans-serif;
    font-size: 14pt;
}

pre {
    margin: 0 0 0 0;
    padding-top: 12pt;
    padding-left: 12pt;
    padding-right: 12pt;
    padding-bottom: 12pt;
    font-size: 12pt;
    text-align: left;
    width: 300pt;
}

.code_piece {
    font-family: monospace;
    padding-left: 4pt;
    padding-right: 4pt;
}


table {
    border-width: 0pt;
}

td {
    vertical-align: top;
    padding: 6pt 12pt 6pt 12pt;
    font-size: 16pt;
    border: 1px solid black;
    width: 505pt;
}

button{
    width: 248pt;
    height: 42pt;
    margin-left:4pt;
    margin-right:4pt;
    font-size: 16pt;
}

u {
    border-bottom: 1px dotted #000;
    text-decoration: none;
    cursor: pointer;
}
    </style>
    <script language="JavaScript">
function next(slides){
    var first_slide = document.getElementById(slides + "_" + 1);
    for(var i = 1; i < 9; ++i)
    {
        var this_slide = document.getElementById(slides + "_" + i);
        var next_slide = document.getElementById(slides + "_" + (i+1));
        if(this_slide)
            if(this_slide.style.display == "block")
                {
                this_slide.style.display = "none";
                if(next_slide)
                    next_slide.style.display = "block";
                else
                    first_slide.style.display = "block";
                return;
                }
    }
}

function draw_results(){
    var d = document.getElementById("results");
    var d_context = d.getContext("2d");
    d_context.font = "16px sans-serif";
    // background
    d_context.fillStyle="#eeeeee";
	d_context.fillRect(0, 0, 700, 500);
	
	var x = 0.0;
	var y = 0.0;
	// static
	x = 0.5;
	y = 499.5;
	d_context.fillStyle="#882200";
	d_context.fillText("0.00 static", x + 4, y - 8);
	d_context.beginPath();
	d_context.strokeStyle="#882200";
	d_context.moveTo(x, y);
	d_context.lineTo(x+99, y);
	d_context.stroke();
	d_context.closePath();
	
	// static A
	x = 100.5;
	y = 499.5 - Math.floor(499 * 0.04 / 2.10);
	d_context.fillStyle="#882200";
	d_context.fillText("0.04 static a", x + 4, y - 8);
	d_context.beginPath();
	d_context.strokeStyle="#882200";
	d_context.moveTo(x, y);
	d_context.lineTo(x+99, y);
	d_context.stroke();
	d_context.closePath();
	
	// static B
	x = 200.5;
	y = 499.5 - Math.floor(499 * 0.10 / 2.10);
	d_context.fillStyle="#882200";
	d_context.fillText("0.10 static b", x + 4, y - 8);
	d_context.beginPath();
	d_context.strokeStyle="#882200";
	d_context.moveTo(x, y);
	d_context.lineTo(x+99, y);
	d_context.stroke();
	d_context.closePath();
	
	// unrolled
	x = 300.5;
	y = 499.5 - Math.floor(499 * 0.10 / 2.10);
	d_context.fillStyle="#882200";
	d_context.fillText("0.10 unrolled", x + 4, y - 8);
	d_context.beginPath();
	d_context.strokeStyle="#882200";
	d_context.moveTo(x, y);
	d_context.lineTo(x+99, y);
	d_context.stroke();
	d_context.closePath();
	
	// triangular
	x = 400.5;
	y = 499.5 - Math.floor(499 * 0.08 / 2.10);
	d_context.fillStyle="#886600";
	d_context.fillText("0.08 triangular", x + 4, y - 8);
	d_context.beginPath();
	d_context.strokeStyle="#886600";
	d_context.moveTo(x, y);
	d_context.lineTo(x+99, y);
	d_context.stroke();
	d_context.closePath();
	
	// lapack
	x = 500.5;
	y = 499.5 - Math.floor(499 * 0.65 / 2.10);
	d_context.fillStyle="#002288";
	d_context.fillText("0.65 LAPACK", x + 4, y - 8);
	d_context.beginPath();
	d_context.strokeStyle="#002288";
	d_context.moveTo(x, y);
	d_context.lineTo(x+99, y);
	d_context.stroke();
	d_context.closePath();
	
	// runtime
	x = 600.5;
	y = 0.05;
	d_context.fillStyle="#AA0011";
	d_context.fillText("2.10 recursive", x - 8, y + 16);
	d_context.beginPath();
	d_context.strokeStyle="#AA0011";
	d_context.moveTo(x, y);
	d_context.lineTo(x+99, y);
	d_context.stroke();
	d_context.closePath();
}

function init_results(){
    draw_results();
}
    </script>
  </head>
  <body>
    <center>
    <h1>
Outperforming LAPACK with C metaprogramming
    </h1>
    <p>
We don't have much tools for metaprogramming in C. We don't have C++' templates or <a href="http://en.cppreference.com/w/cpp/language/constexpr">constexprs</a>, we don't have D's <a href="https://dlang.org/mixin.html">mixins</a>, and we certainly don't have Lisp's and Julia's <a href="https://en.wikipedia.org/wiki/Homoiconicity">homoiconicity</a>. All we have in C is the preprocessor and its macroses. We don't have recursive macroses neither as in macroses that recurrently call themselves, nor as in macroses that define macroses. Apparently you can't implement something as awesome as <a href="https://github.com/kw-udon/constexpr-8cc">a compile time compiler</a> with this.
    </p>
    <p>
Yet with preprocessor macroses only you can help your compiler build you the most efficient code. You can make it compute rather elaborate things statically, and you can make it generate zero-overhead code to win quite a lot in performance. I'll show you a pair of tricks that will turn a crude and inefficient algorithm for solving small linear systems into something that can outrun LAPACK.
    </p>
    <h2>
1. Quasi-recursive inlinable functions
    </h2>
    <p>
Function inlining is the basics of compiler optimization. When the body of function is small and the arguments are numerous it makes perfect sense to build the body into the code directly without arranging the conventional data configurating and jumping there and back in the memory. However, there are things that effectively prevent function inlining and one of them is the recursion.
    </p>
    <p> 
    </p>
    <p>
... 
    </p> 
    <table><tr>
    <td>
    <pre><span id="slides_1_1" style="display:block"> 
1. ...
    </span><span id="slides_1_2" style="display:none"> 
2. ...
    </span><span id="slides_1_3" style="display:none"> 
3. ...
    </span></pre>
    </td>
    </td></tr></table>
    <p style="text-align:right">
    <button type="button" onclick="next('slides_1')">Next step</button>
    </p>
    <p>
...
    </p>
    <canvas id="results" width=700 height=500></canvas>
    <script language="JavaScript">
    init_results();
    </script>
    <p> 
    <p>
...
    </p>

    <p class="footer">
    There are more words and buttons on <a href="index.html">wordsandbuttons.online</a>.<br>
    Also please follow us on <a href="https://twitter.com/wordsandbuttons">Twitter</a>.
    </p>
    </center>
  </body>
</html>
