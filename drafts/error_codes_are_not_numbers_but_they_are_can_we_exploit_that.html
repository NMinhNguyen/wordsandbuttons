<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Error codes are not numbers. But they are. Can we expoit that?</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
    <style>
body {
    margin: 0 0 0 0;
}

a {
    text-decoration: none;
}

h1 {
    padding-top: 36pt;
    font-size: 24pt;
    width: 600pt;
    text-align: left;
}

h2 {
    padding-top: 20pt;
    font-size: 20pt;
    width: 555pt;
    text-align: left;
}

p {
    line-height: 1.42;
    font-size: 16pt;
    width: 505pt;
    text-align: left;
}

pre {
    margin: 0 0 0 0;
    padding-top: 12pt;
    padding-left: 12pt;
    padding-right: 12pt;
    padding-bottom: 12pt;
    font-size: 12pt;
    text-align: left;
    width: 300pt;
}

table {
    border-width: 0pt;
}

td {
    vertical-align: top;
    padding: 6pt 12pt 6pt 12pt;
    font-size: 16pt;
    border: 1px solid black;
    width: 505pt;
}

button {
    width: 248pt;
    height: 42pt;
    margin-left:4pt;
    margin-right:4pt;
    font-size: 16pt;
}

u {
    border-bottom: 1px dotted #000;
    text-decoration: none;
    cursor: pointer;
}
    </style>
    <script language="JavaScript">
const w = 640;
const h = 200;
const cell_width = 64;
const cell_height = 64;
const cell_y = 20;

const button_border = "#999";
const button_shadow = "#444";

// floating point
floating_cell_xs = [20, 20 + 90 + 43 - 32, 20 + 90*2 + 43 - 32, 20 + 90*3 + 43 - 32, 20 + 90*4 + 43*2, 20 + 90*5 + 43*2];
floating_cell_colors = ["#dba0ac", "#acdba0", "#acdba0", "#acdba0", "#cfa0db", "#cfa0db"];
floating_cell_bits = [0, 1, 1, 1, 0, 1];

function init_floating() {
    var floating = document.getElementById("floating");
    floating_draw();

    floating.addEventListener('mousedown', function(e){
        var canvas_rect = floating.getBoundingClientRect();
        var x = e.clientX - canvas_rect.left;
        var y = e.clientY - canvas_rect.top;
        for(var i = 0; i < floating_cell_xs.length; ++i) {
            if (x > floating_cell_xs[i] && x < floating_cell_xs[i] + cell_width && y > cell_y && y < cell_y + cell_height)
                floating_cell_bits[i] = 1 - floating_cell_bits[i];
        }
        floating_draw('down', x, y);
    }, false);

    floating.addEventListener('mouseup', function(e){
        var canvas_rect = floating.getBoundingClientRect();
        var x = e.clientX - canvas_rect.left;
        var y = e.clientY - canvas_rect.top;
        floating_draw('up', x, y);
    }, false);
}

var cur_float = 0.;
function floating_draw(mouse_state, x, y) {
    var floating = document.getElementById("floating");
    var context = floating.getContext("2d");

    // background
    context.fillStyle="#eeee99";
    context.fillRect(0, 0, w, h);

    // cells
    for(var i = 0; i < floating_cell_xs.length; ++i) {
        var text_dx = 0;
        var text_dy = 0;
        if(mouse_state == "down"
        && x >= floating_cell_xs[i] && x - floating_cell_xs[i] < cell_width
        && y >= cell_y && y - cell_y < cell_height) {
            context.fillStyle = button_shadow;
            context.fillRect(floating_cell_xs[i] -1 , cell_y - 1, cell_width + 2, cell_height + 2);
            context.fillStyle = button_border;
            context.fillRect(floating_cell_xs[i], cell_y, cell_width + 1, cell_height + 2);
            text_dx = 1;
            text_dy = 1;
        } else {
            context.fillStyle = button_border;
            context.fillRect(floating_cell_xs[i] -1 , cell_y - 1, cell_width + 1, cell_height + 1);
            context.fillStyle = button_shadow;
            context.fillRect(floating_cell_xs[i], cell_y, cell_width + 1, cell_height + 1);
        }
        context.fillStyle = floating_cell_colors[i];
        context.fillRect(floating_cell_xs[i], cell_y, cell_width, cell_height);

        context.textAlign = "center";
        context.textBaseline = "middle";
        context.font = "48px sans-serif";
        context.fillStyle = "#222222";
        context.fillText(floating_cell_bits[i], text_dx + floating_cell_xs[i] + cell_width / 2.0, text_dy + cell_y + cell_height / 2.0 + 4);
    }

    // the number
    var sign = floating_cell_bits[0] ? -1.0 : 1.0;
    var e = floating_cell_bits[3] + floating_cell_bits[2] * 2 + floating_cell_bits[1] * 4;
    var n = floating_cell_bits[5] + floating_cell_bits[4] * 2 + ((e != 0 && e != 7) ? 4 : 0);

    // explicit point
    if (e != 0 && e != 7) {
        context.fillStyle = "#673670";
        context.fillText("1", 420, cell_y + cell_height / 2.0 + 4);
    }

    // comment
    context.textAlign = "left";
    context.textBaseline = "alphabetic";
    context.font = "20px sans-serif";

    if( e == 7 ) {
        if ( n == 0 ) {
            context.fillStyle = "#914853";
            context.fillText(sign == -1.0 ? "Negative" : "Positive", 20, 120);
            context.fillStyle = "#673670";
            context.fillText("infinite number.", 20, 145);
        } else {
            context.fillStyle = "#673670";
            context.fillText("Not a number.", 20, 120);
        }
        cur_float = NaN;
    } else {
        context.fillStyle = "#914853";
        context.fillText(sign == -1.0 ? "Negative number" : "Positive number", 20, 120);

        context.fillStyle = "#673670"
        context.fillText("of " + n, 20, 145);
        context.fillStyle = "#597052";
        var measures = "quarters,";
        if(e == 2)
            measures = "halves,";
        if(e == 3)
            measures = "wholes,";
        if(e == 4)
            measures = "pairs,";
        if(e == 5)
            measures = "four-packs,";
        if(e == 6)
            measures = "eight-packs,";
        context.fillText(measures, 64, 145);

        context.fillStyle = "#673670"
        context.fillText("which is " + sign * (n * Math.pow(2, e - 2 - (e > 0 ? 1 : 0))).toFixed(2) + " in real numbers", 20, 170);
        cur_float = sign * (n * Math.pow(2, e - 2 - (e > 0 ? 1 : 0))).toFixed(2);
    }
}

function next(slides){
    // show the next slide
    var first_slide = document.getElementById(slides + "_" + 1);
    for(var i = 1; i < 9; ++i)
    {
        var this_slide = document.getElementById(slides + "_" + i);
        var next_slide = document.getElementById(slides + "_" + (i+1));
        if(this_slide)
            if(this_slide.style.display == "block")
                {
                this_slide.style.display = "none";
                if(next_slide)
                    next_slide.style.display = "block";
                else
                    first_slide.style.display = "block";
                break;
                }
    }
    // name the button
    var button = document.getElementById(slides + "_button")
    for(var i = 1; i < 9; ++i)
    {
        var this_slide = document.getElementById(slides + "_" + i);
        var next_slide = document.getElementById(slides + "_" + (i+1));
        if (this_slide && !next_slide && this_slide.style.display == "block") {
            button.innerHTML = "Back to the 1-st slide";
            break;
        }
        else
            button.innerHTML = "Next slide";
    }
}
    </script>
  </head>
  <body>
    <center>
    <h1>
Error codes are not numbers. But they are. Can we expoit that?
    </h1>
    <p>
I saw people doing this a few times in my career. Sometimes with pride, sometimes with a tint of guilt for an obscure hack. Which is odd since there is nothing particularly hacky about it. The ISO/IEC 14882 is ok with this. The IEEE 754 is ok with this. So why is it a hack and not a norm?
    </p>
    <p>
I'm talking, of course, about encoding a return code in a floating point number's significant.
    </p>
    <p>
The floating point numbers are often percieved as mystic and unusual. For isntance, you can't sum up three thirds and expect 1. But this is not due to sorcerry, that's due to engineering.
    </p>
    <p>
A floating point number consists of a sign bit, an exponent, and a significant. The model below is perfectly standard IEEE 754 number, although it is abridged to 6 bits to make it more clickable.
    </p>
    <canvas id="floating" width=640 height=200></canvas>
    <script language="JavaScript">
        init_floating();
    </script>
    <p>
It is set to indicate a "not a number" value. But if you click it long enough, you'll see that a lot of different combinations correspond to different "not a number" values.
    </p>
    <p>
This particular model has 6 of them. 3 with a plus sign, and 3 more with a minus.
    </p>

    <p>
...
    </p>

<table><tr>
    <td>
    <pre>
#include &lt;cassert&gt;
#include &lt;cmath&gt;
#include &lt;cstdint&gt;

enum class ECode : uint64_t {
    INPUT_IS_NAN = 0xFFF0'0000'0000'0001,
    INPUT_IS_INFINITE,
    INPUT_IS_NEGATIVE
};

union Result_or_code
{
    double result;
    ECode code;
    Result_or_code(double x) {result = x;}
    Result_or_code(ECode c) {code = c;}
    operator double() {return result;}
    operator ECode() {return code;}
};

Result_or_code sqrt_or_not(double x) {
    if (std::isnan(x))
        return ECode::INPUT_IS_NAN;
    if (std::isinf(x))
        return ECode::INPUT_IS_INFINITE;
    if(x &lt; 0)
        return ECode::INPUT_IS_NEGATIVE;
    return std::sqrt(x);
}

int main(void) {
    assert(sqrt_or_not(-1.) == ECode::INPUT_IS_NEGATIVE);
    assert(sqrt_or_not(1./0.) == ECode::INPUT_IS_INFINITE);
    assert(sqrt_or_not(0./0.) == ECode::INPUT_IS_NAN);
    assert(sqrt_or_not(4.) == 2.);

    assert(std::isnan(sqrt_or_not(-1.)));
    assert(std::isnan(sqrt_or_not(1./0.)));
    assert(std::isnan(sqrt_or_not(0./0.)));
    assert(std::isnan(sqrt_or_not(-1.) + 1.));
}
    </pre>
    </td>
    </tr></table>
    <p>
...
    </p>

<table><tr>
    <td>
    <pre><span id="slides_1" style="display:block">
1...
</span><span id="slides_2" style="display:none">
2...
</span><span id="slides_3" style="display:none">
3...
</span></pre></td>
    </td></tr></table>
    <p style="text-align:right">
    <button type="button" id="slides_button" onclick="next('slides')">Next slide</button>
    </p>



    <table class="footer" style="width: 555pt; padding: 64pt 0pt 32pt 0pt; background-color: transparent; font-family: sans-serif; font-size: 16pt; font-style: normal;">
    <tr>
    <td class="footer" style="vertical-align: middle; text-align: left; width: 64px; padding: 0; margin: 0; border: 0;">
        <a href="index.html"><img src="favicon.ico"></a>
    </td>
    <td class="footer" style="vertical-align: middle; text-align: left; width: 200pt; padding: 0; margin: 0; border: 0;">
        &nbsp;&larr; there's more.
    </td>
    <td class="footer" style="vertical-align: middle; text-align: right; width: 300pt; padding: 0; margin: 0; border: 0;">
        +
        <a href="https://github.com/akalenuk/wordsandbuttons">Github</a> &
        <a href="https://twitter.com/wordsandbuttons">Twitter</a> &
        <a href="https://news.ycombinator.com/from?site=wordsandbuttons.online">Hacker News</a>
    </td>
    </tr>
    </table>
    </center>
  </body>
</html>
